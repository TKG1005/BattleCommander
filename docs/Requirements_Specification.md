# 要求定義書

---

## 1. 背景・目的
- **背景**  
  ポケットモンスターSV対戦のリアルタイム映像から、重要な試合情報（ポケモン名やHP、技、状態異常など）を自動で抽出し、別途開発済みの対戦AIエージェントに渡すことで、AIによる次の行動判断を高速化・高度化する。  
- **目的**  
  1. キャプチャデバイスから入力されるリアルタイム映像を解析し、AIエージェントが理解可能な形式で情報を **500ms以内**（暫定）に出力する。  
  2. 二次的に、解析結果を人間向けにダッシュボード表示／映像オーバーレイ表示する機能を将来的に追加開発可能とする。

---

## 2. 対象プラットフォーム
- **初期開発**：ローカルで動作する Web アプリケーション  
  - ブラウザ：Chrome／Edge／Safari 等  
  - サーバー：Python（FastAPI）＋WebSocket  
- **将来的拡張**：  
  - Electron／Tauri 等によるデスクトップアプリ化（Windows／macOS）

---

## 3. ステークホルダー
- **AIエージェント開発者**：抽出したデータを投入し、判断ロジックを強化  
- **ゲーム配信者／視聴者**：二次的に可視化・オーバーレイ機能を活用  

---

## 4. ユースケース
| ユースケースID | 概要                                        | 主役      |
|:-------------:|:-------------------------------------------|:---------|
| UC-01         | キャプチャデバイスから映像取得し解析開始     | システム  |
| UC-02         | ポケモンの状態情報（名前・HP等）を抽出      | システム  |
| UC-03         | 技発動／行動順序／状態異常等を抽出          | システム  |
| UC-04         | 抽出結果をJSON（YAML仕様準拠）でAIに送信     | システム  |
| UC-05         | （将来）ダッシュボード／映像オーバーレイで可視化 | システム  |

---

## 5. 機能要件

### 5.1 入力
- **映像解像度／フレームレート**：1080p（1920×1080）／60fps  
- **入力方法**：キャプチャデバイス（HDMIキャプチャなど）からのライブストリーム  
- **API／取得**：ブラウザの `getDisplayMedia` もしくは Python 側での VideoCapture  

### 5.2 情報抽出項目（必須）
1. **ポケモン名**（味方・相手、各１体）  
2. **HP残量**（％表示／比率）  
3. **使用した技**（技名＋発動タイミング）  
4. **行動順序**（ターン内の行動優先度）  
5. **状態異常**（やけど・まひ・ひるみ 等）  
6. **ひんし検知**（残HP＝0 の判定）  
7. **フィールド効果**（天候、ステルスロック、フィールドなど）  
8. **判明した特性**  
9. **判明したもちもの**  

### 5.3 出力
- **フォーマット**：JSON（添付の `state_spec.yml` 準拠）  
- **送信先**：  
  - WebSocket 経由で AI エージェントへプッシュ  
  - （オプション）REST API エンドポイント  

### 5.4 追加機能（将来対応）
- **ダッシュボード表示**：別パネル上にリアルタイム数値・アイコン表示  
- **映像オーバーレイ**：配信映像上への HUD 表示  

---

## 6. 非機能要件

### 6.1 パフォーマンス／精度
- **許容レイテンシ**：500ms以内  
- **解析精度**  
  - HP読み取り誤差：±0.4％以内  
  - 技の識別：99％以上  
  - 状態異常検知：99％以上  

### 6.2 信頼性・安定性
- **稼働時間**：長時間連続運用対応  
- **エラー検知**：解析失敗時はログ出力・再試行  

### 6.3 拡張性・保守性
- モジュール分離（映像取得／前処理、情報抽出、通信）  
- 将来的な技術差し替え（MLモデル更新、UIフレームワーク変更）を容易に  

### 6.4 クロスプラットフォーム対応
- ブラウザベース → OS依存を最小化  
- Desktop化時は Electron/Tauri を想定  

---

## 7. システム構成（高レベル）

┌───────────────┐ ┌───────────┐
│ Capture Device│ ──映像──▶│ Web App │
│ (HDMI/Cam) │ │ (Front: │
└───────────────┘ │ React+WS) │
└───────────┘
│ WebSocket: JSON (state_spec)
▼
┌───────────┐
│ Backend │
│(FastAPI + │
│ OpenCV/ML)│
└───────────┘
│
JSON (AI spec) │
▼
┌───────────┐
│ AI Agent │
└───────────┘


---

## 8. 用語定義
| 用語             | 定義                                                 |
|:---------------|:----------------------------------------------------|
| HUD            | ゲーム映像上に重ねて表示する情報（Head-Up Display） |
| WS／WebSocket  | 双方向通信プロトコル                                |
| HP残量         | 現在HP÷最大HPの比率                                 |
| ひんし         | HP＝0 となり場から退場した状態                       |
